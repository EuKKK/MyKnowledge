# 计算机网络

  因为学习的时候也是自顶向下，因此这里也自顶向下的总结。

## 层次结构

| OSI 模型 | 因特网协议栈 | IP/TCP 四层模型 |                       备注                       |
| :------: | :----------: | :-------------: | :----------------------------------------------: |
|  应用层  |    应用层    |     应用层      | 应用层是网络应用程序及他们的应用层协议存留的地方 |
|  表示层  |     ---      |       ---       |      应用能解释交换数据的含义 (压缩、加密)       |
|  会话层  |     ---      |       ---       |              建立检查点和恢复方案等              |
|  传输层  |    传输层    |     传输层      |          应用程序端到端传输（TCP、UDP）          |
|  网络层  |    网络层    |     网络层      |                 主机到主机（IP）                 |
|  链路层  |    链路层    |   数据链路层    |                 （帧）节点到节点                 |
|  物理层  |    物理层    |       ---       |                （比特）节点间传输                |

## 应用层

​	应用层的协议构成了许多熟悉的应用。

### HTTP

**Hyper Text Transfer Protocol（超文本传输协议）**，承载于**TCP协议**之上，有时也承载于**TLS或SSL**协议之上（**https**）。

​		默认**端口号**为**80**（**https**为**443**）

​		**请求-响应** 模式

​		**无状态**协议，两次请求没有对应关系。

​		**请求**方法：**GET**、**HEAD**、**POST**、**PUT**、**DELETE**、**TRACE**、**OPTIONS**、**CONNECT**

​			**![](https://github.com/noerror0warning/MyKnowledge/tree/master/image/tu1.jpg)**

​		对应的，服务器会返回状态码：

​			**1xx**消息——请求已被服务器接收，继续处理

​			**2xx**成功——请求已成功被服务器接收、理解、并接受

​			**3xx**重定向——需要后续操作才能完成这一请求

​			**4xx**请求错误——请求含有词法错误或者无法被执行

​			**5xx**服务器错误——服务器在处理某个正确请求时发生错误

​			![tu2](https://github.com/noerror0warning/MyKnowledge/tree/master/image/tu2.jpg)

​			**Web**缓冲器，也叫代理服务器，可以配置用户浏览器，使得用户所有HTTP请求首先指向Web缓存器，先检查代理服务器有没有响应报文的副本，没有再向初始服务器请求，通过**条件GET**方法检查缓存是不是最新的。

### FTP

- 维持两个TCP连接，控制连接（端口21）和数据链接（端口20）

- 先建立控制连接，持续的，保持用户状态

- 在数据连接，非持续的，根据控制命令开启传输一个文件，结束就断

### SMTP

​		用于实现电子邮箱传送功能.

### DNS

​	将域名转换为IP地址。		

### Telnet

​	用于实现远程登录



## 运输层

​		传输层向上面的应用层提供通信服务，属于面向通信部分的最高层，也是用户功能中的最底层。传输层为相互通信的应用进程提供了逻辑通信。主要包括两个协议：**TCP协议**和**UDP协议**。

​		

​	主要作用：

​			分段及封装应用层送来的数据。

​			提供端到端的传输服务。

​			在发送主机与接收主机之间构建逻辑通信。



### TCP

- **序号和确认号**
  - 确认号为收到的最后一个序号+1
  - 失序的报文可以丢，但现在一般先保留
- **超时/冗余确认-重传机制**
  - 测量SampleRTT
  - TCP重传会将下一次的超时间隔设置为先前值的两倍
  - 或者收到三个冗余ACK，执行__快速重传__操作
- **流量控制**
  - 滑动窗口机制
  - 接收方告诉发送方缓存窗口剩余容量
  - 发送方未确认的数据大小小于接收方窗口剩余大小
  - 为了避免接收方余量为0，发送方停止发送后，接收方缓存清空，但无法告知发送方（由于TCP仅当在它有数据或有确认要发送的时候才会发送报文段给发送方）；所以TCP规范中要求，当余量为0时，发送方继续发送只有一个字节的报文段，这些报文段都会被接收方确认，并返回ACK
- **拥塞控制**
  - 慢启动 —— 遇到超时，cwnd=1，阈值/2
  - 快速重传，快速恢复 —— 3个冗余ACK，cwnd = max/2 +3, 阈值 = max/2, 进入拥塞避免
  - 拥塞避免 —— 到达阈值，cwnd每个RTT只增加一个MSS
- **三次握手**
  - SYN标志置为1，SYN字段为client_syn（随机）
  - SYN标志置为1，SYN字段为server_syn（随机），ACK字段为client_syn+1
  - SYN标志置为0，SEQ字段为client_syn+1，ACK字段为server_syn+1
  - **不两次握手**：避免第二次的丢失，导致服务端保留连接缓存，但客户端却因未收到ACK而重新建立连接
  - **不四次握手**：最后一次丢失的情况无法避免，三次刚好，多了浪费资源
  - **当最后一个握手ACK丢失**
    - 当Client端收到Server的SYN+ACK应答后，其状态变为ESTABLISHED，并发送ACK包给Server；
    - 如果此时ACK在网络中丢失，那么Server端该TCP连接的状态为SYN_RECV，并且依次等待3秒、6秒、12秒后重新发送SYN+ACK包，以便Client重新发送ACK包，以便Client重新发送ACK包。
    - 如果重发指定次数后，仍然未收到ACK应答，那么一段时间后，Server自动关闭这个连接。
    - 但是Client认为这个连接已经建立，如果Client端向Server写数据，Server端将以RST包响应，方能感知到Server的错误。
- **四次挥手**
  - FIN标志位置为1

### UDP

​	**DNS也用UDP**

- 关于何时、发送什么数据的应用层控制更为精细
- 无需建立连接
- 无连接状态
- 分组开销小 —— 8bytes



## 网络层

​	提供了主机到主机的连接，作用范围包括了给个主机与路由器。仅在网络层提供连接服务的计算机网络称为**虚电路**；仅在网络层提供无连接服务的计算机网络称为**数据报网络**。

提供的特定服务：

- 确保交付

- 具有时延上界的确保交付

- 有序分组交付

- 确保最小带宽

- 确保最大时延抖动

- 安全性服务

  网络层具有三个主要组件：**IP协议、因特网控制报文协议、因特网路由选择协议**。

### IP协议

**IPv4**：

- 地址**32位**，并且分为**A**、**B**、**C**、**D**、**E**五类（主机位全是**0**是网络地址，全是**1**是广播地址）

  ​	<img src="https://github.com/noerror0warning/MyKnowledge/tree/master/image/tu3.png" alt="tu3" style="zoom: 67%;" />

- 数量**有限**

**IPv6**：

- **128**位
- **简化的包头**：IPv6的包头共有8个字段，总长为40字节；而IPv4 的包头包含至少12个字段，长度在没有选项时为20字节，有选 项时60字节。IPv6头减少了字段的数量，提高选路效率。
- **流标志**：IPv4对所有的包同等对待，路由器并不跟踪两台主机 间发送的包。而IPv6引入流概念，对流中的包进行高效处理。
- **身份验证和保密**：IPv6使用了两种安全性扩展，即IP身份验证 头和IP封装安全性净荷。



**IP分片**：一个IP包从源主机传输到目标主机可能需要经过多个不同的物理网络。由于各种网络的数据帧都有一个最大传输单元(**MTU**)的限制，因此路由器转发IP包时，会将其分解成足够小的片段，到达目的主机时才会装起来。



**NAT**:	**网络地址转换协议**，在私有地址和全局地址之间转换的协议。为了解决IPv4地址不够的问题，相当于把端口号也用上作为地址。但是不符合层次结构，也与TCP冲突。



**子网掩码**：IP地址/后的数值，表示前n位为网络号，后面为主机号。



## ICMP

​	**因特网控制报文协议**。ICMP被主机和路由器用来彼此沟通网络层的信息。ICMP通常被认为是IP的一部分，但从体系结构上看，它是位于IP之上的，因为ICMP报文时承载在IP分组中。

-  ICMP协议是一种面向无连接的协议
- 确认IP包是否能成功到达目标地址。
- 通知在发送过程中IP包被丢弃的原因。
- ICMP也是基于IP协议的，所以是网络层协议。
- ICMP只能搭配IPv4 使用，如果是IPv6的情况下，需要的用ICMPv6.





## 因特网路由选择协议

​	网络层最根本的目的是将分组在复杂的网络中从源传送到目的地，而这一过程很大程度上依赖于路由选择，它决定了数据报从源到目的地所流经的路径。

**转发**：当一个分组达到路由器的某个输入链路时，路由器将其移动到合适的输出链路的过程称为转发。

**路由选择**：路由选择是当分组从发送方到接收方时，网络层选取的整个的分组移动路径在选择分组从源到目的地主机的路径时，会依据某些路由选择算法选择路径。

路由选择算法的**分类**：

1. **全局式**还是**分散式**：区别是**基于全局情况**计算费用还是用**迭代、分布式**的方式计算。
2. **静态**与**动态**：取决于随时间流逝**更改的速度**，一般静态的需要人工干预调整转发表。
3. **负载敏感**与**负载迟钝**：链路的**费用**是否反映链路的**拥塞程度**。



**链路状态算法LS**属于全局式路由算法，整个网络状态已知，作为LS算法的输入。而整个链路状态通过链路状态广播算法来完成。

**距离向量路算法DV**属于分散式路由选择算法，采用迭代的、异步的、分布式算法。每个结点从一个或多个直接连接的邻居接受某些信息，执行计算再将结果发送给邻居，直到邻居之间没有更多的信息交换为止。

随着互联网规模的扩大，路由器数量变得十分庞大，算法开销也难以估计的巨大，因此需要把互联网分为一个个**自治系统AS**。在AS内运行的路由选择算法叫做**自治系统内部路由选择协议**。而为了将AS与外界相连，AS中将会有一个或多个路由器负责在AS与外界之间转发分组，这些路由器称为**网关路由器**。

**内部网关协议**：

1. **路由选择信息协议RIP**：每个路由器广播自己的转发表，然后通过接收到的转发表完善自己的转发表。最多支持的跳数为15，**跳数16即不可达**。
2. **开放最短路径优先OSPF**：每个路由将**LSA**（link state advertimenet）广播给邻居，然后把LSA存到**LSDB**（link-state Database）里面，最后用Dijkstra-SPF算法算得最短生成树即路径。为了减少复杂度，会推挤一个**DR**（指定路由器）出来监听网络间拓扑变更信息并通知其他路由器。

**边界网关协议BGP**：跨越多个AS之间源与目的地之间的路径确定。



## 链路层

### MAC地址

- **6个字节48位**
- 网卡是唯一确定的，出厂后即不会改变。
- IP地址描述的是路途的起点和终点，MAC地址描述的是路途中每一个区间的起点和终点。



### ARP协议

ARP协议建立了主机IP地址和MAC地址的映射关系。
